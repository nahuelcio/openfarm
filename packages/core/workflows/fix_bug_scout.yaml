id: fix_bug_scout
name: Fix Bug (Scout Strategy)
description: Optimized workflow with Scout exploration followed by execution.

steps:
  - id: provision-ephemeral-pod
    name: Provision Environment
    type: platform
    action: platform.provision_pod
    config:
      cloneDepth: 1
      npmCache: true
    retryCount: 1
    continueOnError: false

  - id: checkout-main
    name: Checkout Code
    type: git
    action: git.checkout
    config:
      branch: "${workItem.defaultBranch || 'main'}"
    retryCount: 1
    continueOnError: false

  - id: create-fix-branch
    name: Create Branch
    type: git
    action: git.branch
    config:
      pattern: "fix/${workItem.id}-strategic"
    retryCount: 1
    continueOnError: false

  - id: explorer-scout
    name: Scout Files
    type: code
    action: agent.author
    model: "zai/glm-4.7"
    prompt: |
      Analyze the repository context. Your sole objective is to identify strictly the files necessary to resolve: ${workItem.title}.

      Issue Description: ${workItem.description}

      Output Requirement: Return ONLY a list of relative file paths separated by spaces. Do not provide explanations, markdown formatting, or code blocks.
    config:
      chatOnly: true
      systemPrompt: "You are an expert repository navigator. Your output must strictly be a raw string of space-separated relative file paths."
    retryCount: 1

  - id: executor-haiku
    name: Execute Fix
    type: code
    action: agent.code
    model: "zai/glm-4.7"
    prompt: |
      Resolve the following issue: ${workItem.description}.

      Acceptance Criteria:
      ${workItem.acceptanceCriteria}

      Primary Context: Focus your analysis and changes strictly on these identified files: ${stepResults.explorer-scout?.result || ''}
    config:
      provider: "opencode"
      model: "zai/glm-4.7"
      maxIterations: 2
    timeout: 600000
    retryCount: 1
    continueOnError: false

  - id: verify-tests
    name: Verify Tests
    type: command
    action: command.exec
    config:
      cmd: "npm test"
    retryCount: 1
    continueOnError: true

  - id: commit-changes
    name: Commit Changes
    type: git
    action: git.commit
    config:
      message: "fix: ${workItem.title}\n\nExploration results: ${stepResults.explorer-scout?.result || ''}\n\n${workItem.description}"
    retryCount: 1
    continueOnError: false

  - id: push-changes
    name: Push Changes
    type: git
    action: git.push
    config: {}
    retryCount: 2
    continueOnError: false

  - id: create-pr
    name: Create Pull Request
    type: platform
    action: platform.create_pr
    config:
      title: "Fix: ${workItem.title} (Strategic)"
      description: |
        ## Strategic Fix Execution

        **Exploration phase:** Identified relevant files: `${stepResults.explorer-scout?.result || ''}`

        **Execution phase:** Implemented changes based on identified files.

        ### Original Task
        ${workItem.description}

        ### Acceptance Criteria
        ${workItem.acceptanceCriteria}

        ---
        *Automatically generated by Minions Farm*
      target: "${workItem.defaultBranch || 'main'}"
      source: "fix/${workItem.id}-strategic"
    retryCount: 2
    continueOnError: true

  - id: destroy-ephemeral-pod
    name: Cleanup Environment
    type: platform
    action: platform.destroy_pod
    config: {}
    retryCount: 1
    continueOnError: true

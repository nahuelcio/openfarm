id: fix_bug_claude_code
name: Fix Bug (OpenCode)
description: Standard bug fix workflow using OpenCode (AI-powered coding) and PR creation
extends: _base_code

parameters:
  branchPattern:
    type: string
    required: false
    default: "${'fix/' + (workItem.workItemType || 'task') + '-' + workItem.id}"
    description: Pattern for branch name
  commitMessage:
    type: string
    required: false
    default: "fix: ${workItem.title}\n\nFixes #${workItem.id}"
    description: Commit message template
  prTitle:
    type: string
    required: false
    default: "fix: ${workItem.title}"
    description: PR title template

variables:
  defaultBranch: "${workItem.defaultBranch || 'main'}"
  prDescription: |
    ## Description

    ${workItem.description}

    ## Changes

    This PR fixes the bug described in work item #${workItem.id}.

    ## Acceptance Criteria

    ${workItem.acceptanceCriteria}

    ---

    *Automatically generated by Minions Farm*

steps:
  - id: setup
    name: Checkout Base Branch
    type: git
    action: git.checkout
    config:
      branch: "${workItem.defaultBranch || 'main'}"
      customLabel: "üå≥ Checkout Base"
      customDescription: "Switches to base branch (main/master)"
    retryCount: 1
    continueOnError: false

  - id: create-branch
    name: Create Task Branch
    type: git
    action: git.branch
    config:
      pattern: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üå± Create Branch"
      customDescription: "Creates new feature/fix/refactor branch"
    retryCount: 1
    continueOnError: false

  - id: apply-fix
    name: Execute Bug Fix
    type: code
    action: agent.code
    config:
      provider: "opencode"
      model: "zai/glm-4.7"
      customLabel: "üêõ Fix Implementation (OpenCode)"
      customDescription: "OpenCode analyzes and implements the bug fix using OpenCode AI"
    timeout: 600000
    retryCount: 1
    continueOnError: false
    prompt: |
      Fix the bug described in the work item: ${workItem.title}

      Description:
      ${workItem.description}

      Acceptance Criteria:
      ${workItem.acceptanceCriteria}

      Please:
      1. Analyze the bug description carefully
      2. Identify the root cause
      3. Implement a fix that addresses the issue
      4. Ensure the fix follows the existing code style and patterns
      5. Make sure the fix doesn't introduce regressions

  - id: commit
    name: Commit Changes
    type: git
    action: git.commit
    config:
      message: "${commitMessage}"
      customLabel: "üíæ Save Changes"
      customDescription: "Commits all changes with message"
    retryCount: 1
    continueOnError: false

  - id: push
    name: Push Changes
    type: git
    action: git.push
    config:
      customLabel: "‚¨ÜÔ∏è Push to Remote"
      customDescription: "Pushes committed changes to remote repository"
    retryCount: 2
    continueOnError: false

  - id: finalize
    name: Create Pull Request
    type: platform
    action: platform.create_pr
    config:
      title: "${prTitle}"
      description: "${prDescription}"
      target: "${workItem.defaultBranch || 'main'}"
      source: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üîÄ Create PR"
      customDescription: "Opens pull request for code review"
    retryCount: 2
    continueOnError: true

id: fix_bug_planned
name: Fix Bug (Planned)
description: Bug fix with planning phase and human approval
extends: _base_code

parameters:
  branchPattern:
    type: string
    required: false
    default: "fix/${workItem.workItemType}-${workItem.id}"
    description: Pattern for branch name
  commitMessage:
    type: string
    required: false
    default: "fix: ${workItem.title}\n\nFixes #${workItem.id}\n\n${workItem.description}"
    description: Commit message template
  prTitle:
    type: string
    required: false
    default: "fix: ${workItem.title}"
    description: PR title template

variables:
  defaultBranch: "${workItem.defaultBranch || 'main'}"
  prDescription: |
    ## Description

    ${workItem.description}

    ## Changes

    This PR fixes the bug described in work item #${workItem.id}.

    ## Acceptance Criteria

    ${workItem.acceptanceCriteria}

    ---

    *Automatically generated by Minions Farm*

steps:
  - id: setup
    name: Checkout Base Branch
    type: git
    action: git.checkout
    config:
      branch: "${workItem.defaultBranch || 'main'}"
      customLabel: "üîß Prepare Repository"
      customDescription: "Switches to base branch and prepares workspace"
    retryCount: 1
    continueOnError: false

  - id: create-branch
    name: Create Task Branch
    type: git
    action: git.branch
    config:
      pattern: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üå± Create Branch"
      customDescription: "Creates bugfix branch"
    retryCount: 1
    continueOnError: false

  - id: plan
    name: Generate Fix Plan
    type: planning
    action: planning.plan
    config:
      provider: "opencode"
      model: "zai/glm-4.7"
      format: "markdown"
      customLabel: "üìã Generate Plan"
      customDescription: "AI analyzes bug and creates detailed fix strategy"
    timeout: 300000
    retryCount: 1
    continueOnError: false
    prompt: |
      Analyze the bug and generate a detailed plan to fix it:

      **Title:** ${workItem.title}
      **Description:** ${workItem.description}
      **Acceptance Criteria:** ${workItem.acceptanceCriteria}

      The plan must include:
      1. **Bug Analysis**: Identify root cause
      2. **Solution Strategy**: How to address the fix
      3. **Implementation Steps**: Detailed list of changes
      4. **Files to Modify**: List of files
      5. **Risks**: Potential side effects or regressions

  - id: approval
    name: Wait for Approval
    type: human
    action: human.approval
    config:
      timeout: 86400000
      customLabel: "‚úÖ Human Review"
      customDescription: "Waits for human to approve plan before proceeding"
    continueOnError: false

  - id: implement
    name: Execute Approved Plan
    type: code
    action: agent.implement
    config:
      provider: "opencode"
      model: "zai/glm-4.7"
      customLabel: "‚öíÔ∏è Execute Plan"
      customDescription: "OpenCode implements approved fix plan"
    timeout: 600000
    retryCount: 1
    continueOnError: false

  - id: commit
    name: Commit Changes
    type: git
    action: git.commit
    config:
      message: "${commitMessage}"
      customLabel: "üíæ Save Changes"
      customDescription: "Commits all changes with message"
    retryCount: 1
    continueOnError: false

  - id: push
    name: Push Changes
    type: git
    action: git.push
    config:
      customLabel: "‚¨ÜÔ∏è Push to Remote"
      customDescription: "Pushes committed changes to remote repository"
    retryCount: 2
    continueOnError: false

  - id: finalize
    name: Create Pull Request
    type: platform
    action: platform.create_pr
    config:
      title: "${prTitle}"
      description: "${prDescription}"
      target: "${workItem.defaultBranch || 'main'}"
      source: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üöÄ Commit & PR"
      customDescription: "Creates pull request for review"
    retryCount: 2
    continueOnError: true

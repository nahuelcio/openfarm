id: fix_bug_reviewed
name: Fix Bug (Reviewed)
description: Bug fix with automated code review
extends: _base_code

parameters:
  branchPattern:
    type: string
    required: false
    default: "fix/${workItem.workItemType}-${workItem.id}"
    description: Pattern for branch name
  commitMessage:
    type: string
    required: false
    default: "fix: ${workItem.title}\n\nFixes #${workItem.id}\n\n${workItem.description}"
    description: Commit message template
  prTitle:
    type: string
    required: false
    default: "fix: ${workItem.title}"
    description: PR title template

variables:
  defaultBranch: "${workItem.defaultBranch || 'main'}"
  prDescription: |
    ## Description

    ${workItem.description}

    ## Changes

    This PR fixes the bug described in work item #${workItem.id}.

    ## Code Review

    All changes have been reviewed using automated code review.

    ## Acceptance Criteria

    ${workItem.acceptanceCriteria}

    ---

    *Automatically generated by Minions Farm*

steps:
  - id: setup
    name: Checkout Base Branch
    type: git
    action: git.checkout
    config:
      branch: "${workItem.defaultBranch || 'main'}"
      customLabel: "üå≥ Checkout Base"
      customDescription: "Switches to base branch (main/master)"
    retryCount: 1
    continueOnError: false

  - id: create-branch
    name: Create Task Branch
    type: git
    action: git.branch
    config:
      pattern: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üå± Create Branch"
      customDescription: "Creates new bugfix branch"
    retryCount: 1
    continueOnError: false

  - id: apply-fix
    name: Execute Bug Fix
    type: code
    action: agent.code
    config:
      provider: "opencode"
      model: "zai/glm-4.7"
      customLabel: "üêõ Fix Implementation"
      customDescription: "OpenCode analyzes and implements the bug fix"
    timeout: 600000
    retryCount: 1
    continueOnError: false
    prompt: |
      Fix the bug described in the work item: ${workItem.title}

      Description:
      ${workItem.description}

      Acceptance Criteria:
      ${workItem.acceptanceCriteria}

  - id: code-review
    name: Automated Review
    type: review
    action: review.code
    config:
      customLabel: "üëÄ Code Review"
      customDescription: "Automated quality check"
      prompt: |
        # Code Review Rules

        ## General Guidelines
        - Follow existing code style and patterns
        - Write clear, maintainable code
        - Add appropriate comments for complex logic
        - Ensure error handling is present where needed

        ## TypeScript/JavaScript
        - Use proper typing (avoid `any`)
        - Prefer `const` over `let` when possible
        - Use meaningful variable and function names

        ## Best Practices
        - Keep functions focused and single-purpose
        - Avoid deep nesting
        - Write self-documenting code
      filePatterns: "*.ts,*.tsx,*.js,*.jsx"
      excludePatterns: "*.test.ts,*.spec.ts,*.test.tsx,*.spec.tsx,*.d.ts"
      model: "zai/glm-4.7"
      strictMode: true
    timeout: 300000
    retryCount: 1
    continueOnError: false

  - id: commit
    name: Commit Changes
    type: git
    action: git.commit
    config:
      message: "${commitMessage}"
      customLabel: "üíæ Save Changes"
      customDescription: "Commits all changes with message"
    retryCount: 1
    continueOnError: false

  - id: push
    name: Push Changes
    type: git
    action: git.push
    config:
      customLabel: "‚¨ÜÔ∏è Push to Remote"
      customDescription: "Pushes committed changes to remote repository"
    retryCount: 2
    continueOnError: false

  - id: finalize
    name: Create Pull Request
    type: platform
    action: platform.create_pr
    config:
      title: "${prTitle}"
      description: "${prDescription}"
      target: "${workItem.defaultBranch || 'main'}"
      source: "fix/${workItem.workItemType || 'task'}-${workItem.id}"
      customLabel: "üîÄ Create PR"
      customDescription: "Opens pull request for code review"
    retryCount: 2
    continueOnError: true

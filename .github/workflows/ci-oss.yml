# CI/CD para OpenFarm OSS (P√∫blico)
# Publica paquetes a NPM cuando se crea un release

name: CI - OpenFarm OSS

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - '.github/workflows/ci-oss.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/**'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.6"

jobs:
  # Lint y Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Lint
        run: bun run lint

      - name: Type Check
        run: bun run type-check

  # Tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build packages (required for tests with dynamic imports)
        run: bun run build

      - name: Run tests
        run: bun run test

  # Build
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: packages/*/dist

  # Publish a NPM (solo en releases)
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js (for npm publish)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build
        run: bun run build

      - name: Publish all @openfarm/* packages to NPM
        run: |
          # Publicar paquetes en orden de dependencias (base primero, dependientes despu√©s)
          PACKAGES=(
            # Base packages (sin dependencias internas)
            "types"
            "result"
            "logger"
            "config"
            "utils"
            
            # Mid-level packages
            "git-diff"
            "git-adapter"
            "git-worktree"
            "github-adapter"
            "azure-adapter"
            "vault-adapter"
            "context"
            "analysis"
            "queues"
            "execution-logger"
            "operations"
            
            # High-level packages
            "core"
            "coding-engines"
            "runner-utils"
            "agent-runner"
            "workflow-engine"
            "workflow-executor"
            
            # Provider packages
            "provider-opencode"
            "provider-aider"
            "provider-claude"
            
            # Top-level SDK (depends on everything)
            "sdk"
          )

          PUBLISHED=0
          SKIPPED=0
          FAILED=0

          for pkg in "${PACKAGES[@]}"; do
            PKG_DIR="packages/$pkg"
            
            if [ ! -d "$PKG_DIR" ]; then
              echo "‚ö†Ô∏è  Skipping $pkg - directory not found"
              continue
            fi

            cd "$PKG_DIR"
            
            PKG_NAME=$(jq -r '.name' package.json)
            PKG_VERSION=$(jq -r '.version' package.json)
            
            # Skip private packages
            if [ "$(jq -r '.private // false' package.json)" = "true" ]; then
              echo "‚è≠Ô∏è  Skipping $PKG_NAME (private package)"
              cd ../..
              continue
            fi

            # Check if version already exists
            if npm view "$PKG_NAME@$PKG_VERSION" version 2>/dev/null; then
              echo "‚è≠Ô∏è  $PKG_NAME@$PKG_VERSION already exists, skipping"
              SKIPPED=$((SKIPPED + 1))
              cd ../..
              continue
            fi

            # Publish
            echo "üì¶ Publishing $PKG_NAME@$PKG_VERSION..."
            if npm publish --access public; then
              echo "‚úÖ $PKG_NAME published successfully"
              PUBLISHED=$((PUBLISHED + 1))
            else
              echo "‚ùå Failed to publish $PKG_NAME"
              FAILED=$((FAILED + 1))
            fi
            
            cd ../..
          done

          echo ""
          echo "üìä Summary:"
          echo "   ‚úÖ Published: $PUBLISHED"
          echo "   ‚è≠Ô∏è  Skipped: $SKIPPED"
          echo "   ‚ùå Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

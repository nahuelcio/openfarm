# CI/CD para OpenFarm OSS (PÃºblico)
# Publica paquetes a NPM cuando se crea un release

name: CI - OpenFarm OSS

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - '.github/workflows/ci-oss.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/**'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.6"

jobs:
  # Lint y Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Lint
        run: bun run lint

      - name: Type Check
        run: bun run type-check

  # Tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build packages (required for tests with dynamic imports)
        run: bun run build

      - name: Run tests
        run: bun run test

  # Build
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: packages/*/dist

  # Publish a NPM (solo en releases)
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js (for npm publish)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen

      - name: Build
        run: bun run build

      - name: Publish all @openfarm/* packages to NPM
        run: |
          # Publicar paquetes en orden de dependencias (base primero, dependientes despuÃ©s)
          PACKAGES=(
            # Base packages (sin dependencias internas)
            "types"
            "result"
            "logger"
            "config"
            "utils"
            
            # Mid-level packages
            "git-diff"
            "git-adapter"
            "git-worktree"
            "github-adapter"
            "azure-adapter"
            "vault-adapter"
            "context"
            "analysis"
            "queues"
            "execution-logger"
            "operations"
            
            # High-level packages
            "core"
            "coding-engines"
            "runner-utils"
            "agent-runner"
            "workflow-engine"
            "workflow-executor"
            
            # Provider packages
            "provider-opencode"
            "provider-aider"
            "provider-claude"
            
            # Top-level SDK (depends on everything)
            "sdk"
          )

          PUBLISHED=0
          SKIPPED=0
          FAILED=0

          for pkg in "${PACKAGES[@]}"; do
            PKG_DIR="packages/$pkg"
            
            if [ ! -d "$PKG_DIR" ]; then
              echo "âš ï¸  Skipping $pkg - directory not found"
              continue
            fi

            cd "$PKG_DIR"
            
            PKG_NAME=$(jq -r '.name' package.json)
            PKG_VERSION=$(jq -r '.version' package.json)
            
            # Skip private packages
            if [ "$(jq -r '.private // false' package.json)" = "true" ]; then
              echo "â­ï¸  Skipping $PKG_NAME (private package)"
              cd ../..
              continue
            fi

            # Check if version already exists
            if npm view "$PKG_NAME@$PKG_VERSION" version 2>/dev/null; then
              echo "â­ï¸  $PKG_NAME@$PKG_VERSION already exists, skipping"
              SKIPPED=$((SKIPPED + 1))
              cd ../..
              continue
            fi

            # Publish
            echo "ðŸ“¦ Publishing $PKG_NAME@$PKG_VERSION..."
            if npm publish --access public; then
              echo "âœ… $PKG_NAME published successfully"
              PUBLISHED=$((PUBLISHED + 1))
            else
              echo "âŒ Failed to publish $PKG_NAME"
              FAILED=$((FAILED + 1))
            fi
            
            cd ../..
          done

          echo ""
          echo "ðŸ“Š Summary:"
          echo "   âœ… Published: $PUBLISHED"
          echo "   â­ï¸  Skipped: $SKIPPED"
          echo "   âŒ Failed: $FAILED"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Build standalone executables for all platforms
  build-executables:
    name: Build Executables
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release' && github.event.action == 'published'
    strategy:
      matrix:
        include:
          - target: bun-linux-x64
            os_name: linux
            arch: x64
            ext: ""
          - target: bun-linux-arm64
            os_name: linux
            arch: arm64
            ext: ""
          - target: bun-darwin-x64
            os_name: macos
            arch: x64
            ext: ""
          - target: bun-darwin-arm64
            os_name: macos
            arch: arm64
            ext: ""
          - target: bun-windows-x64
            os_name: windows
            arch: x64
            ext: ".exe"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen

      - name: Build executable for ${{ matrix.os_name }}-${{ matrix.arch }}
        working-directory: packages/sdk
        run: |
          bun build ./src/cli.ts \
            --compile \
            --target=${{ matrix.target }} \
            --outfile=../../openfarm-${{ matrix.os_name }}-${{ matrix.arch }}${{ matrix.ext }}

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: openfarm-${{ matrix.os_name }}-${{ matrix.arch }}
          path: openfarm-${{ matrix.os_name }}-${{ matrix.arch }}${{ matrix.ext }}

  # Upload executables to GitHub Release
  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [build-executables, publish]
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create checksums
        run: |
          cd artifacts
          for dir in */; do
            for file in "$dir"*; do
              if [ -f "$file" ]; then
                sha256sum "$file" >> checksums.txt
              fi
            done
          done
          cat checksums.txt

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/openfarm-linux-x64/openfarm-linux-x64
            artifacts/openfarm-linux-arm64/openfarm-linux-arm64
            artifacts/openfarm-macos-x64/openfarm-macos-x64
            artifacts/openfarm-macos-arm64/openfarm-macos-arm64
            artifacts/openfarm-windows-x64/openfarm-windows-x64.exe
            artifacts/checksums.txt
